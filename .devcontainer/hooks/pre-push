#!/bin/bash
# Pre-push hook to check for AI mentions and Co-Authored-By in commits

set -e

echo "ğŸ” Checking commits for AI mentions and Co-Authored-By..."

# Get the remote and branch being pushed to
remote="$1"
url="$2"

# Get all commits that will be pushed
zero_commit="0000000000000000000000000000000000000000"

while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" = "$zero_commit" ]; then
        # Handle delete
        continue
    fi

    if [ "$remote_sha" = "$zero_commit" ]; then
        # New branch, check all commits from main
        range="origin/main..$local_sha"
        if ! git rev-parse origin/main >/dev/null 2>&1; then
            # No origin/main, check all commits
            range="$local_sha"
        fi
    else
        # Update to existing branch, examine new commits
        range="$remote_sha..$local_sha"
    fi

    # Keywords to search for (case insensitive)
    AI_KEYWORDS=(
        "claude"
        "chatgpt"
        "gpt-"
        "copilot"
        "ai generated"
        "generated by ai"
        "generated with ai"
        "with the help of"
        "assisted by"
        "ğŸ¤–"
        "co-authored-by: claude"
        "co-authored-by: github-actions"
        "co-authored-by: bot"
    )

    # Check each commit in the range
    found_issues=false
    problem_commits=()

    for commit in $(git rev-list "$range"); do
        commit_msg=$(git log -1 --format=%B "$commit")
        commit_short=$(git log -1 --format=%h "$commit")
        commit_subject=$(git log -1 --format=%s "$commit")

        # Check for AI keywords
        for keyword in "${AI_KEYWORDS[@]}"; do
            if echo "$commit_msg" | grep -qi "$keyword"; then
                if [ "$found_issues" = false ]; then
                    echo ""
                    echo "âŒ Found commits with AI mentions or Co-Authored-By:"
                    echo ""
                    found_issues=true
                fi
                echo "  Commit: $commit_short - \"$commit_subject\""
                echo "  Found: '$keyword' in commit message"
                echo ""
                problem_commits+=("$commit")
                break
            fi
        done
    done

    if [ "$found_issues" = true ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ Push rejected!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Commits to fix:"
        for commit in "${problem_commits[@]}"; do
            echo "  $(git log -1 --format='%h - %s' "$commit")"
        done
        echo ""
        echo "To fix these commits, use one of the following methods:"
        echo ""
        echo "1. Interactive rebase to edit commit messages:"
        echo "   git rebase -i HEAD~N  (where N is the number of commits)"
        echo "   Change 'pick' to 'reword' for the problematic commits"
        echo ""
        echo "2. Amend the last commit (if it's the most recent):"
        echo "   git commit --amend"
        echo ""
        echo "3. Filter commits to remove AI mentions:"
        echo "   git filter-branch --msg-filter 'sed \"s/Co-Authored-By.*//g\"' HEAD~N..HEAD"
        echo ""
        echo "After fixing, force push with:"
        echo "   git push --force-with-lease"
        echo ""
        echo "To bypass this check (NOT recommended):"
        echo "   git push --no-verify"
        echo ""
        exit 1
    fi
done

echo "âœ… No AI mentions or Co-Authored-By found in commits"
exit 0
