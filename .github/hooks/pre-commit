#!/bin/bash
# Copyright (c) 2024 Florent (Kodflow). All rights reserved.
# Licensed under the Sustainable Use License 1.0
# See LICENSE.md in the project root for license information.

# Pre-commit hook to add copyright headers and generate documentation

set -e

# Colors
CYAN='\033[36m'
GREEN='\033[32m'
YELLOW='\033[33m'
RED='\033[31m'
RESET='\033[0m'
BOLD='\033[1m'

# Check if committing directly to main branch
BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")
if [ "$BRANCH" = "main" ]; then
  echo ""
  echo -e "${BOLD}${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
  echo -e "${BOLD}${RED}❌ Direct commits to 'main' branch are forbidden!${RESET}"
  echo -e "${BOLD}${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
  echo ""
  echo -e "Please use a feature branch and create a Pull Request:"
  echo -e "  ${CYAN}git checkout -b feat/my-feature${RESET}"
  echo -e "  ${CYAN}git commit${RESET}"
  echo -e "  ${CYAN}git push origin feat/my-feature${RESET}"
  echo ""
  echo -e "Then create a PR on GitHub to merge into main."
  echo ""
  exit 1
fi

echo ""
echo -e "${BOLD}${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
echo -e "${BOLD}  Pre-commit checks${RESET}"
echo -e "${BOLD}${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
echo ""

# Add copyright headers to modified files
echo -e "${BOLD}1. Adding copyright headers...${RESET}"
if ! ./scripts/add-copyright-headers.sh; then
  echo -e "${RED}✗${RESET} Failed to add copyright headers"
  exit 1
fi
echo ""

# Generate documentation (COVERAGE.MD)
echo -e "${BOLD}2. Generating coverage documentation...${RESET}"
./scripts/generate-coverage.sh > /dev/null 2>&1

# Stage coverage file if it was modified
if [ -f "COVERAGE.MD" ]; then
  git add COVERAGE.MD
fi
echo -e "${GREEN}✓${RESET} Documentation updated"
echo ""

echo -e "${BOLD}${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
echo -e "${BOLD}${GREEN}✓${RESET} Pre-commit checks passed${RESET}"
echo -e "${BOLD}${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
echo ""
