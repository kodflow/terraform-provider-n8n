#!/bin/bash
# Copyright (c) 2024 Florent (Kodflow). All rights reserved.
# Licensed under the Sustainable Use License 1.0
# See LICENSE.md in the project root for license information.

# Pre-commit hook to add copyright headers and generate documentation

set -e

# Colors
CYAN='\033[36m'
GREEN='\033[32m'
YELLOW='\033[33m'
RED='\033[31m'
RESET='\033[0m'
BOLD='\033[1m'

# Check if committing directly to main branch
BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")
if [ "$BRANCH" = "main" ]; then
  echo ""
  echo -e "${BOLD}${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
  echo -e "${BOLD}${RED}❌ Direct commits to 'main' branch are forbidden!${RESET}"
  echo -e "${BOLD}${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
  echo ""
  echo -e "Please use a feature branch and create a Pull Request:"
  echo -e "  ${CYAN}git checkout -b feat/my-feature${RESET}"
  echo -e "  ${CYAN}git commit${RESET}"
  echo -e "  ${CYAN}git push origin feat/my-feature${RESET}"
  echo ""
  echo -e "Then create a PR on GitHub to merge into main."
  echo ""
  exit 1
fi

echo ""
echo -e "${BOLD}${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
echo -e "${BOLD}  Pre-commit checks${RESET}"
echo -e "${BOLD}${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
echo ""

# Verify all commits in branch are GPG signed
echo -e "${BOLD}1. Verifying GPG signatures on all commits in branch...${RESET}"

# Get merge base with main branch
MERGE_BASE=$(git merge-base main HEAD 2>/dev/null || echo "")

if [ -n "$MERGE_BASE" ]; then
  # Get all commits in the branch
  COMMITS=$(git rev-list $MERGE_BASE..HEAD)

  if [ -n "$COMMITS" ]; then
    UNSIGNED_COMMITS=""
    TOTAL_COMMITS=$(echo "$COMMITS" | wc -l | tr -d ' ')
    CHECKED=0

    for commit in $COMMITS; do
      CHECKED=$((CHECKED + 1))
      # Check if commit has a valid GPG signature
      if ! git verify-commit "$commit" >/dev/null 2>&1; then
        COMMIT_MSG=$(git log -1 --format=%s "$commit")
        UNSIGNED_COMMITS="${UNSIGNED_COMMITS}\n  - ${CYAN}${commit:0:7}${RESET} $COMMIT_MSG"
      fi
    done

    if [ -n "$UNSIGNED_COMMITS" ]; then
      echo ""
      echo -e "${BOLD}${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
      echo -e "${BOLD}${RED}❌ ERROR: Found unsigned commits in branch!${RESET}"
      echo -e "${BOLD}${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
      echo ""
      echo -e "The following commits are ${RED}NOT signed${RESET} with GPG:"
      echo -e "$UNSIGNED_COMMITS"
      echo ""
      echo -e "${BOLD}To fix this, re-sign all commits with:${RESET}"
      echo -e "  ${CYAN}git rebase --exec 'git commit --amend --no-edit -S' $MERGE_BASE${RESET}"
      echo ""
      echo -e "Then force push:"
      echo -e "  ${CYAN}git push --force-with-lease${RESET}"
      echo ""
      exit 1
    fi

    echo -e "${GREEN}✓${RESET} All $TOTAL_COMMITS commits are GPG signed"
  fi
fi
echo ""

# Add copyright headers to modified files
echo -e "${BOLD}2. Adding copyright headers...${RESET}"
if ! ./scripts/add-copyright-headers.sh; then
  echo -e "${RED}✗${RESET} Failed to add copyright headers"
  exit 1
fi
echo ""

# Generate documentation (COVERAGE.MD)
echo -e "${BOLD}3. Generating coverage documentation...${RESET}"
./scripts/generate-coverage.sh > /dev/null 2>&1

# Stage coverage file if it was modified
if [ -f "COVERAGE.MD" ]; then
  git add COVERAGE.MD
fi
echo -e "${GREEN}✓${RESET} Documentation updated"
echo ""

echo -e "${BOLD}${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
echo -e "${BOLD}${GREEN}✓${RESET} Pre-commit checks passed${RESET}"
echo -e "${BOLD}${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${RESET}"
echo ""
