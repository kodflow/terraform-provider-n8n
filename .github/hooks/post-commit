#!/bin/bash
# Post-commit hook to verify GPG signature

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo ""
echo "üîê Verifying GPG signature on commit..."

# Get the signature status of the last commit
SIGNATURE=$(git log -1 --format="%G?")
SIGNER=$(git log -1 --format="%GS")
KEY=$(git log -1 --format="%GK")

case "$SIGNATURE" in
  G)
    echo -e "${GREEN}‚úÖ Commit successfully signed!${NC}"
    echo -e "   Signer: $SIGNER"
    echo -e "   Key ID: $KEY"
    echo ""
    exit 0
    ;;
  B)
    echo -e "${RED}‚ùå BAD signature detected!${NC}"
    echo -e "${RED}The commit signature is invalid.${NC}"
    echo ""
    echo "To fix this:"
    echo "  1. Amend the commit with proper signing:"
    echo "     git commit --amend --no-edit -S"
    echo ""
    exit 1
    ;;
  U)
    echo -e "${YELLOW}‚ö†Ô∏è  Untrusted signature detected${NC}"
    echo -e "   Signer: $SIGNER"
    echo -e "   Key ID: $KEY"
    echo ""
    echo "The key is not trusted. To trust it:"
    echo "  gpg --edit-key $KEY"
    echo "  > trust"
    echo "  > quit"
    echo ""
    exit 0
    ;;
  X)
    echo -e "${RED}‚ùå Signature with expired key!${NC}"
    echo ""
    echo "To fix this:"
    echo "  1. Extend your key expiration or create a new key"
    echo "  2. Amend the commit: git commit --amend --no-edit -S"
    echo ""
    exit 1
    ;;
  Y)
    echo -e "${RED}‚ùå Signature with expired key (made by good key)!${NC}"
    echo ""
    exit 1
    ;;
  R)
    echo -e "${RED}‚ùå Signature with revoked key!${NC}"
    echo ""
    exit 1
    ;;
  E)
    echo -e "${RED}‚ùå Cannot check signature!${NC}"
    echo "GPG key missing or signature unreadable."
    echo ""
    exit 1
    ;;
  N)
    echo -e "${RED}‚ùå COMMIT NOT SIGNED!${NC}"
    echo ""
    echo "This should not happen if the commit-msg hook is working."
    echo ""
    echo "To fix immediately:"
    echo "  git commit --amend --no-edit -S"
    echo ""
    echo "Or configure automatic signing:"
    echo "  git config --global commit.gpgsign true"
    echo "  git config --global user.signingkey YOUR_GPG_KEY_ID"
    echo ""
    exit 1
    ;;
  *)
    echo -e "${RED}‚ùå Unknown signature status: $SIGNATURE${NC}"
    echo ""
    exit 1
    ;;
esac
