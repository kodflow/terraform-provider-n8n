#!/bin/bash
# Validate commit message with commitlint

COMMIT_MSG_FILE=$1

# ============================================================================
# GPG Signature Verification
# ============================================================================
echo "üîê Checking GPG signature requirement..."

# Check if GPG signing is enabled
GPG_SIGN=$(git config --get commit.gpgsign)
SIGNING_KEY=$(git config --get user.signingkey)

if [ "$GPG_SIGN" != "true" ]; then
    echo ""
    echo "‚ùå GPG signing is not enabled!"
    echo ""
    echo "All commits MUST be signed with a GPG key."
    echo ""
    echo "To enable GPG signing:"
    echo "  1. Configure GPG signing:"
    echo "     git config --global commit.gpgsign true"
    echo ""
    echo "  2. Set your GPG signing key:"
    echo "     git config --global user.signingkey YOUR_GPG_KEY_ID"
    echo ""
    echo "  3. List your GPG keys to find the key ID:"
    echo "     gpg --list-secret-keys --keyid-format=long"
    echo ""
    exit 1
fi

if [ -z "$SIGNING_KEY" ]; then
    echo ""
    echo "‚ùå No GPG signing key configured!"
    echo ""
    echo "Please configure your GPG signing key:"
    echo "  1. List your GPG keys:"
    echo "     gpg --list-secret-keys --keyid-format=long"
    echo ""
    echo "  2. Set your signing key:"
    echo "     git config --global user.signingkey YOUR_GPG_KEY_ID"
    echo ""
    exit 1
fi

# Verify the GPG key exists
if ! gpg --list-secret-keys "$SIGNING_KEY" &> /dev/null; then
    echo ""
    echo "‚ùå GPG key $SIGNING_KEY not found in keyring!"
    echo ""
    echo "Please ensure your GPG key is available:"
    echo "  gpg --list-secret-keys --keyid-format=long"
    echo ""
    exit 1
fi

echo "‚úÖ GPG signature enabled with key: $SIGNING_KEY"
echo ""

# ============================================================================
# Commit Message Validation
# ============================================================================

# Check if commitlint is installed
if ! command -v commitlint &> /dev/null; then
    echo "‚ö†Ô∏è  commitlint not found, skipping validation"
    echo "   Install with: npm install -g @commitlint/cli @commitlint/config-conventional"
    exit 0
fi

# Check if config file exists
if [ ! -f ".commitlintrc.json" ]; then
    echo "‚ö†Ô∏è  .commitlintrc.json not found, skipping validation"
    exit 0
fi

# Validate commit message
echo "üîç Validating commit message..."

# Check for forbidden AI mentions first
if grep -qi "co-authored-by.*claude\|co-authored-by.*gpt\|ü§ñ generated with\|claude code\|generated with.*ai" "$COMMIT_MSG_FILE"; then
    echo ""
    echo "‚ùå Commit message contains forbidden AI attribution!"
    echo ""
    echo "Remove the following from your commit message:"
    echo "  - Co-Authored-By: Claude"
    echo "  - Co-Authored-By: GPT"
    echo "  - ü§ñ Generated with [Claude Code]"
    echo "  - Any AI mentions or attributions"
    echo ""
    exit 1
fi

if commitlint --edit "$COMMIT_MSG_FILE"; then
    echo "‚úÖ Commit message valid"
    exit 0
else
    echo ""
    echo "‚ùå Invalid commit message format!"
    echo ""
    echo "Expected format: <type>: <description>"
    echo ""
    echo "Valid types:"
    echo "  feat:     New feature"
    echo "  fix:      Bug fix"
    echo "  docs:     Documentation changes"
    echo "  test:     Test additions/changes"
    echo "  refactor: Code refactoring"
    echo "  perf:     Performance improvements"
    echo "  build:    Build system changes"
    echo "  ci:       CI/CD changes"
    echo "  chore:    Maintenance tasks"
    echo "  revert:   Revert previous commit"
    echo ""
    echo "Examples:"
    echo "  feat: add workflow datasource"
    echo "  fix: resolve null pointer in credential resource"
    echo "  docs: update README with new examples"
    echo ""
    exit 1
fi
