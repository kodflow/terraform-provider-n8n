#!/bin/bash
# Validate commit message with commitlint

COMMIT_MSG_FILE=$1

# Check if commitlint is installed
if ! command -v commitlint &> /dev/null; then
    echo "‚ö†Ô∏è  commitlint not found, skipping validation"
    echo "   Install with: npm install -g @commitlint/cli @commitlint/config-conventional"
    exit 0
fi

# Check if config file exists
if [ ! -f ".commitlintrc.json" ]; then
    echo "‚ö†Ô∏è  .commitlintrc.json not found, skipping validation"
    exit 0
fi

# Validate commit message
echo "üîç Validating commit message..."

# Check for forbidden AI mentions first
if grep -qi "co-authored-by.*claude\|co-authored-by.*gpt\|ü§ñ generated with\|claude code\|generated with.*ai" "$COMMIT_MSG_FILE"; then
    echo ""
    echo "‚ùå Commit message contains forbidden AI attribution!"
    echo ""
    echo "Remove the following from your commit message:"
    echo "  - Co-Authored-By: Claude"
    echo "  - Co-Authored-By: GPT"
    echo "  - ü§ñ Generated with [Claude Code]"
    echo "  - Any AI mentions or attributions"
    echo ""
    exit 1
fi

if commitlint --edit "$COMMIT_MSG_FILE"; then
    echo "‚úÖ Commit message valid"
    exit 0
else
    echo ""
    echo "‚ùå Invalid commit message format!"
    echo ""
    echo "Expected format: <type>: <description>"
    echo ""
    echo "Valid types:"
    echo "  feat:     New feature"
    echo "  fix:      Bug fix"
    echo "  docs:     Documentation changes"
    echo "  test:     Test additions/changes"
    echo "  refactor: Code refactoring"
    echo "  perf:     Performance improvements"
    echo "  build:    Build system changes"
    echo "  ci:       CI/CD changes"
    echo "  chore:    Maintenance tasks"
    echo "  revert:   Revert previous commit"
    echo ""
    echo "Examples:"
    echo "  feat: add workflow datasource"
    echo "  fix: resolve null pointer in credential resource"
    echo "  docs: update README with new examples"
    echo ""
    exit 1
fi
