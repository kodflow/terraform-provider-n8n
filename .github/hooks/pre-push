#!/usr/bin/env bash
# Pre-push hook to check for AI mentions and Co-Authored-By in ALL commits

set -e

echo "ğŸ” Checking ALL commits in branch history for AI mentions..."

# Get the remote and branch being pushed to
remote="$1"
url="$2"

# Keywords to search for (case insensitive)
AI_KEYWORDS=(
    "claude"
    "chatgpt"
    "gpt-"
    "copilot"
    "ai generated"
    "generated by ai"
    "generated with ai"
    "with the help of"
    "assisted by"
    "ğŸ¤–"
    "co-authored-by: claude"
    "co-authored-by: github-actions"
    "co-authored-by: bot"
)

# Get all commits that will be pushed
zero_commit="0000000000000000000000000000000000000000"

# Track all problem commits - use temp file instead of associative array
problem_commits_file=$(mktemp)
trap "rm -f $problem_commits_file" EXIT
found_issues=false

while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" = "$zero_commit" ]; then
        # Handle delete
        continue
    fi

    # Determine range to check - we want to check ALL commits in the branch
    if [ "$remote_sha" = "$zero_commit" ]; then
        # New branch, check all commits from main
        if git rev-parse origin/main >/dev/null 2>&1; then
            range="origin/main..$local_sha"
        else
            # No origin/main, check all commits in branch
            range="$local_sha"
        fi
    else
        # Existing branch - check ALL commits in branch, not just new ones
        # This ensures we catch any problematic commits in history
        if git rev-parse origin/main >/dev/null 2>&1; then
            range="origin/main..$local_sha"
        else
            range="$remote_sha..$local_sha"
        fi
    fi

    # Check each commit in the range
    for commit in $(git rev-list "$range"); do
        # Skip if already processed
        if grep -q "^$commit|" "$problem_commits_file" 2>/dev/null; then
            continue
        fi

        commit_msg=$(git log -1 --format=%B "$commit")
        commit_short=$(git log -1 --format=%h "$commit")
        commit_subject=$(git log -1 --format=%s "$commit")

        # Check for AI keywords
        found_keyword=""
        for keyword in "${AI_KEYWORDS[@]}"; do
            if echo "$commit_msg" | grep -qi "$keyword"; then
                found_keyword="$keyword"
                break
            fi
        done

        if [ -n "$found_keyword" ]; then
            echo "$commit|$found_keyword" >> "$problem_commits_file"
            found_issues=true
        fi
    done
done

if [ "$found_issues" = true ]; then
    echo ""
    echo "âŒ Found commits with AI mentions or Co-Authored-By in branch history:"
    echo ""

    # Sort commits by date (oldest first) for easier fixing
    for commit in $(git rev-list --reverse origin/main..HEAD 2>/dev/null || git rev-list --reverse HEAD); do
        if grep -q "^$commit|" "$problem_commits_file" 2>/dev/null; then
            commit_short=$(git log -1 --format=%h "$commit")
            commit_subject=$(git log -1 --format=%s "$commit")
            keyword=$(grep "^$commit|" "$problem_commits_file" | cut -d'|' -f2)
            echo "  ğŸ“ $commit_short - \"$commit_subject\""
            echo "     Found: '$keyword'"
            echo ""
        fi
    done

    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âŒ Push rejected!"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Total problematic commits: $(wc -l < "$problem_commits_file")"
    echo ""
    echo "To fix ALL commits at once, use interactive rebase:"
    echo ""
    echo "1. Count commits from main:"
    commit_count=$(git rev-list --count origin/main..HEAD 2>/dev/null || echo "unknown")
    if [ "$commit_count" != "unknown" ]; then
        echo "   git rebase -i HEAD~$commit_count"
    else
        echo "   git rebase -i <base-commit>"
    fi
    echo ""
    echo "2. In the editor, change 'pick' to 'reword' for each problematic commit"
    echo ""
    echo "3. For each commit, edit the message to remove AI mentions"
    echo ""
    echo "4. After rebase, force push:"
    echo "   git push --force-with-lease"
    echo ""
    echo "Alternative: Fix last commit only (if it's the only one):"
    echo "   git commit --amend"
    echo ""
    echo "To bypass this check (NOT recommended):"
    echo "   git push --no-verify"
    echo ""
    exit 1
fi

echo "âœ… No AI mentions or Co-Authored-By found in branch history"
exit 0
