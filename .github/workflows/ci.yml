name: CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
      - feat/ci-pipeline-v2

permissions:
  contents: read

jobs:
  ci:
    name: CI Pipeline
    runs-on: ubuntu-latest
    env:
      N8N_API_URL: ${{ secrets.N8N_API_URL }}
      N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
    steps:
      # Checkout repository
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      # Setup Go
      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: "go.mod"
          cache: true

      # Setup Bazel
      - name: Set up Bazel
        uses: bazel-contrib/setup-bazel@4fd964a13a440a8aeb0be47350db2fc640f19ca8 # v0.15.0

      # Setup Python for SDK generation
      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.x"

      # Install SDK generation tools
      - name: Install SDK tools
        run: make tools/sdk

      # Generate SDK from OpenAPI (no commit in CI)
      - name: Generate OpenAPI spec
        run: make openapi

      # Generate Go SDK from OpenAPI
      - name: Generate Go SDK
        run: make sdk

      # Download Go dependencies (after SDK generation)
      - name: Download dependencies
        run: make deps

      # Clean Bazel cache after SDK generation
      - name: Clean Bazel cache
        run: make clean

      # Install development tools
      - name: Install development tools
        run: make tools

      # Setup Terraform
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: latest

      # Install linting tools
      - name: Install linting tools
        run: make tools/lint

      # Check code formatting
      - name: Check formatting
        run: make fmt

      # Run linters
      - name: Run linters
        run: make lint

      # Run unit tests
      - name: Run unit tests
        run: make test/unit/ci

      # Build provider
      - name: Build provider
        run: make build

      # Run acceptance tests (only if credentials are available)
      - name: Run acceptance tests
        run: make test/acceptance/ci
        if: ${{ env.N8N_API_URL != '' && env.N8N_API_KEY != '' }}

      # Generate documentation
      - name: Generate documentation
        run: make docs
