name: CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  ci:
    name: CI Pipeline
    runs-on: ubuntu-latest
    env:
      N8N_URL: ${{ secrets.N8N_URL }}
      N8N_API_TOKEN: ${{ secrets.N8N_API_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Install Bazelisk
        run: |
          sudo wget -O /usr/local/bin/bazel https://github.com/bazelbuild/bazelisk/releases/latest/download/bazelisk-linux-amd64
          sudo chmod +x /usr/local/bin/bazel

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Python dependencies
        run: pip install pyyaml requests

      - name: Install OpenAPI Generator
        run: |
          wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/7.10.0/openapi-generator-cli-7.10.0.jar -O /tmp/openapi-generator-cli.jar
          echo '#!/bin/bash' | sudo tee /usr/local/bin/openapi-generator > /dev/null
          echo 'java -jar /tmp/openapi-generator-cli.jar "$@"' | sudo tee -a /usr/local/bin/openapi-generator > /dev/null
          sudo chmod +x /usr/local/bin/openapi-generator

      - name: Generate SDK
        run: python3 codegen/build-sdk.py

      - name: Run gazelle to update BUILD files
        run: bazel run //:gazelle

      - name: Clean Bazel cache after SDK generation
        run: bazel clean

      - name: Download Go dependencies
        run: go mod download

      - name: Install formatting tools
        run: |
          go install golang.org/x/tools/cmd/goimports@latest
          go install github.com/bazelbuild/buildtools/buildifier@latest
          go install mvdan.cc/sh/v3/cmd/shfmt@latest
          npm install -g prettier

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Install ktn-linter
        run: |
          KTN_ARCH=$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/')
          KTN_VERSION=$(curl -s https://api.github.com/repos/kodflow/ktn-linter/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
          mkdir -p $HOME/.local/bin
          curl -fsSL "https://github.com/kodflow/ktn-linter/releases/download/v${KTN_VERSION}/ktn-linter-linux-${KTN_ARCH}" -o "$HOME/.local/bin/ktn-linter"
          chmod +x "$HOME/.local/bin/ktn-linter"
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Check formatting
        run: make fmt

      - name: Run linters
        run: make lint

      - name: Run unit tests
        run: bazel test --test_output=all --test_verbose_timeout_warnings //src/...

      - name: Build provider
        run: make build

      - name: Run acceptance tests
        run: make test/acceptance
        if: ${{ env.N8N_URL != '' && env.N8N_API_TOKEN != '' }}

      - name: Generate documentation
        run: make docs

      - name: Check for uncommitted changes
        run: |
          # Exclude auto-generated documentation files from the check
          CHANGED_FILES=$(git status --porcelain | grep -v "CHANGELOG.md" | grep -v "COVERAGE.MD" || true)
          if [ -n "$CHANGED_FILES" ]; then
            echo "Error: There are uncommitted changes after running CI pipeline"
            echo "$CHANGED_FILES"
            echo ""
            echo "Showing diff of changed files:"
            git diff
            exit 1
          fi
          echo "âœ“ No unexpected file changes detected"
