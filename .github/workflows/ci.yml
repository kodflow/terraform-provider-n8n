name: CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build-and-test:
    name: Build & Quality Checks
    runs-on: ubuntu-latest
    steps:
      # Checkout repository
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      # CRITICAL: Validate secrets are available before wasting time
      - name: Validate required secrets
        run: |
          echo "ðŸ” Validating required secrets..."
          MISSING_SECRETS=0

          if [ -z "${{ secrets.N8N_API_URL }}" ]; then
            echo "âŒ CRITICAL: N8N_API_URL secret is NOT set!"
            MISSING_SECRETS=1
          else
            echo "âœ“ N8N_API_URL is configured"
          fi

          if [ -z "${{ secrets.N8N_API_KEY }}" ]; then
            echo "âŒ CRITICAL: N8N_API_KEY secret is NOT set!"
            MISSING_SECRETS=1
          else
            echo "âœ“ N8N_API_KEY is configured"
          fi

          if [ $MISSING_SECRETS -eq 1 ]; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ PIPELINE FAILED: Missing required secrets!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "Please configure the following secrets in:"
            echo "Repository Settings â†’ Secrets and variables â†’ Actions"
            echo ""
            echo "Required secrets:"
            echo "  - N8N_API_URL: Your n8n instance URL"
            echo "  - N8N_API_KEY: Your n8n API key"
            echo ""
            exit 1
          fi

          echo "âœ… All required secrets are configured"

      # Setup Go
      - name: Set up Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: "go.mod"
          cache: true

      # Setup Bazel
      - name: Set up Bazel
        uses: bazel-contrib/setup-bazel@4fd964a13a440a8aeb0be47350db2fc640f19ca8 # v0.15.0
        with:
          disk-cache: true
          repository-cache: true

      # Setup Terraform (needed for terraform validate in lint step)
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: "1.9.0"

      # Install all development tools (includes dependencies, dev tools, and linting tools)
      - name: Install tools
        run: make tools

      # Build provider (needed for terraform validate in lint step)
      - name: Build provider for validation
        run: make build

      # Check code formatting
      - name: Check formatting
        run: make fmt

      # Run linters
      - name: Run linters
        run: make lint

      # Run unit tests with coverage
      - name: Run unit tests with coverage
        run: |
          echo "Running tests with coverage collection..."
          bazel coverage --combined_report=lcov --instrumentation_filter="//src/..." //src/...
          echo ""
          echo "Coverage report generated at: bazel-out/_coverage/_coverage_report.dat"
          echo ""
          echo "Coverage summary:"
          # Display coverage summary from LCOV
          if [ -f bazel-out/_coverage/_coverage_report.dat ]; then
            TOTAL_LINES=$(grep -c "^DA:" bazel-out/_coverage/_coverage_report.dat || echo 0)
            HIT_LINES=$(grep "^DA:" bazel-out/_coverage/_coverage_report.dat | grep -v ",0$" | wc -l || echo 0)
            if [ "$TOTAL_LINES" -gt 0 ]; then
              COVERAGE=$(awk "BEGIN {printf \"%.1f\", ($HIT_LINES / $TOTAL_LINES) * 100}")
              echo "  Lines covered: $HIT_LINES / $TOTAL_LINES ($COVERAGE%)"
            fi
          fi

      # Rename coverage report for Codacy
      - name: Rename coverage report for Codacy
        run: |
          mv bazel-out/_coverage/_coverage_report.dat bazel-out/_coverage/_coverage_report.lcov
          echo "Coverage report renamed to .lcov for better Codacy detection"

      # Upload coverage to Codacy
      - name: Upload coverage to Codacy
        uses: codacy/codacy-coverage-reporter-action@89d6c85cfafaec52c72b6c5e8b2878d33104c699 # v1.3.0
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: bazel-out/_coverage/_coverage_report.lcov
        continue-on-error: true

      # Build provider with Bazel
      - name: Build provider
        run: make build

      # Validate all Terraform examples with locally built provider
      - name: Validate Terraform examples
        run: make test/validate-examples

      # Upload provider binary for test jobs
      - name: Upload provider binary
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808 # v4.3.3
        with:
          name: terraform-provider-n8n
          path: bazel-bin/src/terraform-provider-n8n_/terraform-provider-n8n
          retention-days: 1

      # Run acceptance tests (pass env vars directly)
      - name: Run acceptance tests
        env:
          N8N_API_URL: ${{ secrets.N8N_API_URL }}
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
          TF_ACC: "1"
        run: |
          echo "Running E2E acceptance tests..."
          go test -v -tags=acceptance -timeout 30m ./src/internal/provider/credential/... ./src/internal/provider/tag/... ./src/internal/provider/variable/... ./src/internal/provider/workflow/...

      # Generate documentation
      - name: Generate documentation
        run: make docs

  plan-examples:
    name: Plan - ${{ matrix.example-name }}
    runs-on: ubuntu-latest
    needs: build-and-test
    strategy:
      fail-fast: false
      matrix:
        include:
          - example-name: basic-sample
            example-path: examples/basic-sample
          - example-name: community-credentials
            example-path: examples/community/credentials/basic-auth
          - example-name: community-tags
            example-path: examples/community/tags/workflow-tags
          - example-name: community-workflow-basic
            example-path: examples/community/workflows/basic-workflow
          - example-name: community-workflow-scheduled
            example-path: examples/community/workflows/scheduled-workflow
    steps:
      # Checkout repository
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      # Setup Terraform
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: "1.9.0"

      # Download provider binary
      - name: Download provider binary
        uses: actions/download-artifact@65a9edc5881444af0b9093a5e628f2fe47ea3b2e # v4.1.7
        with:
          name: terraform-provider-n8n
          path: /tmp/terraform-provider

      # Make provider binary executable
      - name: Make provider executable
        run: chmod +x /tmp/terraform-provider/terraform-provider-n8n

      # Health check - verify n8n instance is reachable
      - name: Health check n8n instance
        env:
          N8N_API_URL: ${{ secrets.N8N_API_URL }}
        run: |
          echo "ðŸ¥ Checking n8n instance health..."
          if curl -f -s -o /dev/null -w "%{http_code}" --max-time 10 "$N8N_API_URL" | grep -q "200\|301\|302"; then
            echo "âœ… n8n instance is reachable"
          else
            echo "âŒ n8n instance is not reachable"
            exit 1
          fi

      # Configure Terraform to use local provider
      - name: Configure Terraform dev overrides
        run: |
          mkdir -p ~/.terraform.d
          cat > ~/.terraformrc <<EOF
          provider_installation {
            dev_overrides {
              "kodflow/n8n" = "/tmp/terraform-provider"
            }
            direct {}
          }
          EOF

      # Terraform Validate & Plan
      - name: Terraform Validate & Plan
        env:
          TF_VAR_n8n_api_key: ${{ secrets.N8N_API_KEY }}
          TF_VAR_n8n_base_url: ${{ secrets.N8N_API_URL }}
          TF_VAR_run_id: ${{ github.run_number }}
          TF_VAR_timestamp: ${{ github.run_number }}-${{ github.run_attempt }}
        working-directory: ${{ matrix.example-path }}
        run: |
          echo "ðŸ” Validating configuration..."
          terraform validate -no-color

          echo "ðŸ“‹ Planning infrastructure changes..."
          terraform plan -no-color -input=false -out=tfplan

      # Upload plan for apply job
      - name: Upload Terraform plan
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808 # v4.3.3
        with:
          name: tfplan-${{ matrix.example-name }}
          path: ${{ matrix.example-path }}/tfplan
          retention-days: 1

  apply-examples:
    name: Apply - ${{ matrix.example-name }}
    runs-on: ubuntu-latest
    needs: plan-examples
    strategy:
      fail-fast: false
      matrix:
        include:
          - example-name: basic-sample
            example-path: examples/basic-sample
          - example-name: community-credentials
            example-path: examples/community/credentials/basic-auth
          - example-name: community-tags
            example-path: examples/community/tags/workflow-tags
          - example-name: community-workflow-basic
            example-path: examples/community/workflows/basic-workflow
          - example-name: community-workflow-scheduled
            example-path: examples/community/workflows/scheduled-workflow
    steps:
      # Checkout repository
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      # Setup Terraform
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: "1.9.0"

      # Download provider binary
      - name: Download provider binary
        uses: actions/download-artifact@65a9edc5881444af0b9093a5e628f2fe47ea3b2e # v4.1.7
        with:
          name: terraform-provider-n8n
          path: /tmp/terraform-provider

      # Download plan from plan job
      - name: Download Terraform plan
        uses: actions/download-artifact@65a9edc5881444af0b9093a5e628f2fe47ea3b2e # v4.1.7
        with:
          name: tfplan-${{ matrix.example-name }}
          path: ${{ matrix.example-path }}

      # Make provider binary executable
      - name: Make provider executable
        run: chmod +x /tmp/terraform-provider/terraform-provider-n8n

      # Configure Terraform to use local provider
      - name: Configure Terraform dev overrides
        run: |
          mkdir -p ~/.terraform.d
          cat > ~/.terraformrc <<EOF
          provider_installation {
            dev_overrides {
              "kodflow/n8n" = "/tmp/terraform-provider"
            }
            direct {}
          }
          EOF

      # Terraform Apply
      - name: Terraform Apply
        env:
          TF_VAR_n8n_api_key: ${{ secrets.N8N_API_KEY }}
          TF_VAR_n8n_base_url: ${{ secrets.N8N_API_URL }}
          TF_VAR_run_id: ${{ github.run_number }}
          TF_VAR_timestamp: ${{ github.run_number }}-${{ github.run_attempt }}
        working-directory: ${{ matrix.example-path }}
        run: |
          echo "ðŸš€ Applying infrastructure changes..."
          terraform apply -no-color -auto-approve tfplan

          echo "ðŸ“¤ Outputs:"
          terraform output -no-color || true

      # Verify resources created via n8n API
      - name: Verify resources via n8n API
        env:
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
          N8N_API_URL: ${{ secrets.N8N_API_URL }}
        working-directory: ${{ matrix.example-path }}
        run: |
          echo "ðŸ” Verifying resources created via n8n API..."

          # Extract resource IDs from terraform output
          terraform output -json > outputs.json

          # Check based on example type
          case "${{ matrix.example-name }}" in
            "community-tags")
              echo "Checking tags via API..."
              RESPONSE=$(curl -s -H "X-N8N-API-KEY: $N8N_API_KEY" "$N8N_API_URL/api/v1/tags")
              echo "API Response: $RESPONSE"

              # Verify tags were created (with timestamp format: ci-RUN_NUMBER-TIMESTAMP-TYPE)
              # The timestamp is RUN_NUMBER-RUN_ATTEMPT, resulting in: ci-235-235-1-prod
              if echo "$RESPONSE" | grep -q "ci-${{ github.run_number }}-${{ github.run_number }}-${{ github.run_attempt }}-"; then
                echo "âœ… Tags verified successfully"
              else
                echo "âŒ Tags not found in API response"
                exit 1
              fi
              ;;
            "community-workflow-basic"|"community-workflow-scheduled")
              echo "Checking workflows via API..."
              RESPONSE=$(curl -s -H "X-N8N-API-KEY: $N8N_API_KEY" "$N8N_API_URL/api/v1/workflows")
              echo "API Response: $RESPONSE"

              # Verify workflow was created
              if echo "$RESPONSE" | grep -q "ci-${{ github.run_number }}"; then
                echo "âœ… Workflow verified successfully"
              else
                echo "âŒ Workflow not found in API response"
                exit 1
              fi
              ;;
            *)
              echo "â„¹ï¸  Skipping API verification for ${{ matrix.example-name }}"
              ;;
          esac

      # Upload state file for destroy job
      - name: Upload Terraform state
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808 # v4.3.3
        with:
          name: tfstate-${{ matrix.example-name }}
          path: ${{ matrix.example-path }}/terraform.tfstate
          retention-days: 1

  destroy-examples:
    name: Destroy - ${{ matrix.example-name }}
    runs-on: ubuntu-latest
    needs: apply-examples
    if: always()
    strategy:
      fail-fast: false
      matrix:
        include:
          - example-name: basic-sample
            example-path: examples/basic-sample
          - example-name: community-credentials
            example-path: examples/community/credentials/basic-auth
          - example-name: community-tags
            example-path: examples/community/tags/workflow-tags
          - example-name: community-workflow-basic
            example-path: examples/community/workflows/basic-workflow
          - example-name: community-workflow-scheduled
            example-path: examples/community/workflows/scheduled-workflow
    steps:
      # Checkout repository
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      # Setup Terraform
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: "1.9.0"

      # Download provider binary
      - name: Download provider binary
        uses: actions/download-artifact@65a9edc5881444af0b9093a5e628f2fe47ea3b2e # v4.1.7
        with:
          name: terraform-provider-n8n
          path: /tmp/terraform-provider

      # Download state file from apply job
      - name: Download Terraform state
        uses: actions/download-artifact@65a9edc5881444af0b9093a5e628f2fe47ea3b2e # v4.1.7
        with:
          name: tfstate-${{ matrix.example-name }}
          path: ${{ matrix.example-path }}
        continue-on-error: true

      # Make provider binary executable
      - name: Make provider executable
        run: chmod +x /tmp/terraform-provider/terraform-provider-n8n

      # Configure Terraform to use local provider
      - name: Configure Terraform dev overrides
        run: |
          mkdir -p ~/.terraform.d
          cat > ~/.terraformrc <<EOF
          provider_installation {
            dev_overrides {
              "kodflow/n8n" = "/tmp/terraform-provider"
            }
            direct {}
          }
          EOF

      # Terraform Destroy
      - name: Terraform Destroy
        env:
          TF_VAR_n8n_api_key: ${{ secrets.N8N_API_KEY }}
          TF_VAR_n8n_base_url: ${{ secrets.N8N_API_URL }}
          TF_VAR_run_id: ${{ github.run_number }}
          TF_VAR_timestamp: ${{ github.run_number }}-${{ github.run_attempt }}
        working-directory: ${{ matrix.example-path }}
        run: |
          echo "ðŸ§¹ Destroying infrastructure..."
          terraform destroy -no-color -input=false -auto-approve
